# 知识图谱系统 - Knowledge Graph System

## 📋 系统概述

这是一个AI驱动的传记知识图谱系统，能够从对话和文本中自动提取并结构化人物、地点、时间和事件信息。

## 🏗️ 核心架构

### 1. 数据模型（5张核心表）

#### Person（人物表）
- 存储传记中的所有人物信息
- 支持多个别称/昵称（aliases）
- 记录与主人公的关系（role）
- 自动计算重要度评分（importance_score）
- 关联头像和封面照片

#### Place（地点表）
- 存储传记中的所有地点
- 支持层级结构（国家→城市→区县→具体地点）
- 可选的经纬度坐标（lat/lng）
- 父级地点引用（parent_place_id）

#### TimeRef（时间引用表）
- 存储各种时间表达
- 三种类型：exact（精确）、range（范围）、fuzzy（模糊）
- 支持原文表达（如"那年冬天"、"小学三年级"）
- 可推断的ISO日期（start_date/end_date）
- 置信度评分

#### Event（事件表）
- 存储人生中的重要事件
- 关联时间、人物、地点
- 支持标签分类（tags）
- 原文证据片段（evidence）
- 待确认/已确认状态（verified）

#### Memory（回忆表）
- 存储具体的回忆片段
- 可关联人物、事件、地点、时间
- 原文引用（quote）
- 照片附件

### 2. 三大核心页面

#### /family - 人物中心页（People Hub）
- **功能**：
  - 显示所有人物卡片（头像、关系、重要度）
  - 点击进入人物详情页
  - 查看与该人物的共同回忆
  - 关联的照片和事件
  
- **数据来源**：`people` 表 + 关联查询

#### /timeline - 时间轴页
- **功能**：
  - 纵向时间线展示所有事件
  - 每个节点包含：标题、摘要、关联人物/地点、原文证据
  - 多维筛选：按人物、地点、标签、验证状态
  - 展开查看原文证据
  
- **数据来源**：`events` 表 + `time_refs` + `event_people` + `event_places`

#### /places - 地图页
- **功能**：
  - 地点列表（按层级分组）
  - 点击查看地点详情
  - 关联事件和人物
  - 子地点展示（zoom in 效果）
  
- **数据来源**：`places` 表 + 关联查询
- **未来增强**：集成 Mapbox/Google Maps 显示地图

### 3. AI抽取流程

#### Step 1: AI 自动抽取
- **入口**：`/extract` 页面
- **输入**：用户粘贴对话记录或文本
- **API**：`/api/ai/extract-entities`
- **模型**：OpenAI GPT-4o-mini
- **输出**：结构化的人物、地点、时间、事件列表

#### Step 2: 用户审核确认
- 显示AI抽取结果
- 自动选中置信度 > 0.7 的结果
- 用户可：
  - 勾选/取消选择
  - 查看原文证据
  - 修改信息（未来增强）
- 批量保存到数据库

#### Step 3: 编辑和关联
- 保存后在各个页面查看
- 人物详情页编辑资料
- 合并重复人物（未来增强）
- 补充地理坐标（未来增强）

## 🚀 使用流程

### 1. 数据库迁移

```bash
# 在 Supabase Dashboard 执行
# 文件：supabase/migrations/20260115_knowledge_graph.sql
```

关键表：
- `people`
- `places`
- `time_refs`
- `events`
- `memories`
- `event_people`（关联表）
- `event_places`（关联表）

### 2. AI 抽取使用示例

1. 访问 `/extract` 页面
2. 粘贴对话文本：
   ```
   我小时候住在牡丹江，那时候父亲在第一小学当老师。
   记得有一年冬天，爸爸带我去公园看雪雕...
   ```
3. 点击"开始 AI 抽取"
4. 审核结果：
   - 人物：父亲（别名：爸爸）
   - 地点：牡丹江、第一小学、公园
   - 时间：小学时期、某年冬天
   - 事件：父亲带我看雪雕
5. 选择要保存的项
6. 点击"保存到知识图谱"

### 3. 查看和编辑

**人物页面** (`/family`)：
- 查看所有人物卡片
- 点击进入详情页
- 编辑资料、上传头像

**时间轴** (`/timeline`)：
- 按时间顺序查看事件
- 筛选特定人物或地点
- 查看原文证据

**地图** (`/places`)：
- 按层级浏览地点
- 查看地点相关事件和人物
- 探索子地点

## 📊 数据流图

```
用户输入文本
    ↓
AI 实体抽取 (GPT-4o-mini)
    ↓
结构化结果（人物/地点/时间/事件）
    ↓
用户审核确认
    ↓
保存到数据库（5张表）
    ↓
三大页面展示（人物/时间轴/地图）
    ↓
用户编辑完善
    ↓
导出成书（PDF）
```

## 🎯 核心优势

1. **AI自动化**：80%工作由AI完成，用户只需确认
2. **结构化存储**：知识图谱模型，关联清晰
3. **多维查询**：人物、地点、时间三个维度交叉筛选
4. **渐进增强**：先快速建立框架，后续慢慢完善
5. **证据追踪**：每个抽取结果都有原文证据

## 🔧 技术栈

- **前端**：Next.js 16 + React + TypeScript
- **后端**：Supabase (PostgreSQL + RLS)
- **AI**：OpenAI GPT-4o-mini
- **样式**：Tailwind CSS
- **地图**：待集成 Mapbox/Google Maps

## 📈 未来增强计划

### Phase 1（当前版本）
- ✅ 数据库表结构
- ✅ 基础CRUD API
- ✅ 三大核心页面
- ✅ AI实体抽取
- ✅ 审核确认流程

### Phase 2（近期）
- [ ] 地图可视化（Mapbox集成）
- [ ] 人物关系图谱
- [ ] 时间轴可视化优化
- [ ] 照片与事件关联
- [ ] 批量导入对话记录

### Phase 3（中期）
- [ ] 智能推荐（"您可能忘记的人物"）
- [ ] 时间推断优化（"小学三年级"→精确年份）
- [ ] 地点层级自动识别
- [ ] 人物合并工具
- [ ] 事件补全建议

### Phase 4（长期）
- [ ] 多项目管理
- [ ] 协作编辑（家族传记）
- [ ] 语音输入抽取
- [ ] 视频记忆分析
- [ ] 3D时空可视化

## 📝 API端点

### AI抽取
- `POST /api/ai/extract-entities`
  - 输入：`{ text: string, projectId: string }`
  - 输出：`{ people, places, times, events }`

### 人物
- `getPeople(projectId, filters?)` - 获取人物列表
- `getPerson(personId)` - 获取人物详情
- `createPerson(person)` - 创建人物
- `updatePerson(personId, updates)` - 更新人物
- `deletePerson(personId)` - 删除人物

### 地点
- `getPlaces(projectId, filters?)` - 获取地点列表
- `getPlace(placeId)` - 获取地点详情
- `createPlace(place)` - 创建地点
- `updatePlace(placeId, updates)` - 更新地点

### 事件
- `getEvents(projectId, filters?)` - 获取事件列表
- `createEvent(event, peopleIds, placeIds)` - 创建事件
- `updateEvent(eventId, updates)` - 更新事件

### 回忆
- `getMemories(projectId)` - 获取回忆列表
- `createMemory(memory)` - 创建回忆

## 🎨 UI特色

- **渐变背景**：每个页面独特的渐变色彩
  - 人物页：蓝紫渐变
  - 时间轴：琥珀渐变
  - 地图：绿青渐变
  - AI抽取：靛粉渐变

- **卡片设计**：玻璃态卡片 + 阴影
- **交互反馈**：hover状态 + 过渡动画
- **置信度标识**：颜色编码（绿色高、黄色中、红色低）
- **证据展开**：折叠/展开原文证据

## 📖 最佳实践

1. **定期AI抽取**：每次对话后及时抽取
2. **及时审核**：趁记忆清晰时确认信息
3. **补充细节**：为人物添加头像和简介
4. **关联照片**：将照片与人物/事件关联
5. **验证事件**：确认AI抽取的事件准确性
6. **完善地点**：补充地理坐标和描述

## 🐛 已知限制

1. 地图页暂无真实地图显示（需集成API）
2. 时间推断依赖AI（可能不准确）
3. 人物合并需手动操作
4. 暂不支持批量编辑
5. RGB色彩空间（印刷需转CMYK）

## 📞 问题反馈

如遇到问题，请检查：
1. Supabase数据库迁移是否执行
2. `OPENAI_API_KEY` 环境变量是否设置
3. 浏览器控制台是否有错误
4. 网络请求是否成功

---

**版本**：1.0.0  
**更新日期**：2026-01-15  
**作者**：永恒档案开发团队
